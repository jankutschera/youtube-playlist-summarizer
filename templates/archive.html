{% extends "base.html" %}

{% block content %}
<div class="search-bar">
    <input type="text" id="searchInput" placeholder="üîç Archiv durchsuchen..." onkeyup="searchVideos()">
</div>

<div class="stats">
    <div class="stat-card">
        <h3>Archivierte Videos</h3>
        <div class="number">{{ total }}</div>
    </div>
    <div class="stat-card">
        <h3>Info</h3>
        <div class="number" style="font-size: 16px; color: #aaa;">üìÅ Gespeichert</div>
    </div>
</div>

{% if grouped_videos %}
<div id="videoContainer">
    {% for group_name, videos in grouped_videos.items() %}
    <div class="date-group">
        <h2 class="date-header">{{ group_name }} <span class="video-count">({{ videos|length }})</span></h2>
        <div class="video-grid">
            {% for video in videos %}
            <div class="video-card" data-video-id="{{ video.id }}">
                <div class="video-clickable" onclick="window.location.href='/video/{{ video.id }}'">
                    <img src="{{ video.thumbnail }}" alt="{{ video.title }}">
                    <div class="video-info">
                        <div class="video-title">{{ video.title }}</div>
                        <div class="video-meta">
                            {{ video.channel }}<br>
                            <small>{{ video.processed_at }}</small>
                        </div>
                        {% if video.summary %}
                        <div class="video-summary">
                            {{ (video.summary[:200] + '...') | markdown_to_html | safe }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="video-actions">
                    <button class="action-btn restore-btn" onclick="restoreVideo('{{ video.id }}', event)" title="Zur√ºck zur Hauptseite">
                        ‚Ü©Ô∏è Wiederherstellen
                    </button>
                    <button class="action-btn remove-btn" onclick="removeVideo('{{ video.id }}', event)" title="Video entfernen">
                        üóëÔ∏è Entfernen
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <h2>Noch keine Videos archiviert</h2>
    <p>Videos die du archivierst werden hier gespeichert.</p>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function searchVideos() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const container = document.getElementById('videoContainer');
    const groups = container.getElementsByClassName('date-group');

    for (let group of groups) {
        const cards = group.getElementsByClassName('video-card');
        let visibleCount = 0;

        for (let card of cards) {
            const title = card.querySelector('.video-title').textContent.toLowerCase();
            const meta = card.querySelector('.video-meta').textContent.toLowerCase();
            const summary = card.querySelector('.video-summary')?.textContent.toLowerCase() || '';

            if (title.includes(filter) || meta.includes(filter) || summary.includes(filter)) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        }

        // Hide group header if no videos visible
        group.style.display = visibleCount > 0 ? '' : 'none';
    }
}

async function restoreVideo(videoId, event) {
    event.stopPropagation(); // Prevent navigation to video detail

    if (!confirm('M√∂chtest du dieses Video wiederherstellen?')) {
        return;
    }

    try {
        const response = await fetch(`/api/video/${videoId}/restore`, {
            method: 'POST'
        });

        if (response.ok) {
            // Remove the card from the DOM with animation
            const card = document.querySelector(`[data-video-id="${videoId}"]`);
            card.style.opacity = '0';
            card.style.transform = 'scale(0.8)';
            setTimeout(() => card.remove(), 300);
        } else {
            alert('Fehler beim Wiederherstellen des Videos');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim Wiederherstellen des Videos');
    }
}

async function removeVideo(videoId, event) {
    event.stopPropagation(); // Prevent navigation to video detail

    if (!confirm('M√∂chtest du dieses Video wirklich entfernen?')) {
        return;
    }

    try {
        const response = await fetch(`/api/video/${videoId}/remove`, {
            method: 'POST'
        });

        if (response.ok) {
            // Remove the card from the DOM with animation
            const card = document.querySelector(`[data-video-id="${videoId}"]`);
            card.style.opacity = '0';
            card.style.transform = 'scale(0.8)';
            setTimeout(() => card.remove(), 300);
        } else {
            alert('Fehler beim Entfernen des Videos');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim Entfernen des Videos');
    }
}
</script>
{% endblock %}
